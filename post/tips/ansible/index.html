<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>ansible - Andy's Blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="Andy Zhang"><meta name=description content="How to run ansible adhoc command?  ansible &amp;lt;targets&amp;gt; -m ping to ping targets ansible &amp;lt;targets&amp;gt; -a 'systemctl status' to run a command on targets ansible &amp;lt;targets&amp;gt; -m user -a &amp;quot;name=foo state=absent to run a ansible module on targets
 How to reboot and wait for linux server to come back? Sample code is as the following:
1 2 3 4 5 6 7  ## name: Upgrade Kernel | Reboot servercommand:&amp;#39;sleep 5 &amp;amp;&amp;amp; /sbin/reboot&amp;#39;async:10poll:0## name: Waiting for server to come backlocal_action:wait_forhost={{ansible_ssh_host}}state=started  Note: it is important to sleep for a while before rebooting, otherwise, async seems not working, maybe because ssh connection is suddenly lost before async takes affect."><meta name=keywords content="linux,SRE,software"><meta name=generator content="Hugo 0.60.1 with theme even"><link rel=canonical href=http://localhost:1313/post/tips/ansible/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/dist/even.c2a46f00.min.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="ansible"><meta property="og:description" content="How to run ansible adhoc command?  ansible <targets> -m ping to ping targets ansible <targets> -a 'systemctl status' to run a command on targets ansible <targets> -m user -a &#34;name=foo state=absent to run a ansible module on targets
 How to reboot and wait for linux server to come back? Sample code is as the following:
1 2 3 4 5 6 7  ## name: Upgrade Kernel | Reboot servercommand:'sleep 5 && /sbin/reboot'async:10poll:0## name: Waiting for server to come backlocal_action:wait_forhost={{ansible_ssh_host}}state=started  Note: it is important to sleep for a while before rebooting, otherwise, async seems not working, maybe because ssh connection is suddenly lost before async takes affect."><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/post/tips/ansible/"><meta property="article:published_time" content="2017-06-13T11:48:45+08:00"><meta property="article:modified_time" content="2019-11-13T16:38:07+08:00"><meta itemprop=name content="ansible"><meta itemprop=description content="How to run ansible adhoc command?  ansible <targets> -m ping to ping targets ansible <targets> -a 'systemctl status' to run a command on targets ansible <targets> -m user -a &#34;name=foo state=absent to run a ansible module on targets
 How to reboot and wait for linux server to come back? Sample code is as the following:
1 2 3 4 5 6 7  ## name: Upgrade Kernel | Reboot servercommand:'sleep 5 && /sbin/reboot'async:10poll:0## name: Waiting for server to come backlocal_action:wait_forhost={{ansible_ssh_host}}state=started  Note: it is important to sleep for a while before rebooting, otherwise, async seems not working, maybe because ssh connection is suddenly lost before async takes affect."><meta itemprop=datePublished content="2017-06-13T11:48:45+08:00"><meta itemprop=dateModified content="2019-11-13T16:38:07+08:00"><meta itemprop=wordCount content="1373"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="ansible"><meta name=twitter:description content="How to run ansible adhoc command?  ansible <targets> -m ping to ping targets ansible <targets> -a 'systemctl status' to run a command on targets ansible <targets> -m user -a &#34;name=foo state=absent to run a ansible module on targets
 How to reboot and wait for linux server to come back? Sample code is as the following:
1 2 3 4 5 6 7  ## name: Upgrade Kernel | Reboot servercommand:'sleep 5 && /sbin/reboot'async:10poll:0## name: Waiting for server to come backlocal_action:wait_forhost={{ansible_ssh_host}}state=started  Note: it is important to sleep for a while before rebooting, otherwise, async seems not working, maybe because ssh connection is suddenly lost before async takes affect."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Andy's Blog</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>Andy's Blog</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>ansible</h1><div class=post-meta><span class=post-time>2017-06-13</span><div class=post-category><a href=/categories/tip/>tip</a></div><span class=more-meta>1373 words</span>
<span class=more-meta>7 mins read</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#how-to-run-ansible-adhoc-commandhttpsdocsansiblecomansiblelatestuserguideintroadhochtml>How to run ansible adhoc command?</a></li><li><a href=#how-to-reboot-and-wait-for-linux-server-to-come-back>How to reboot and wait for linux server to come back?</a></li><li><a href=#a-lot-of-ip-address-operation-such-as-ipaddrhttpsdocsansiblecomansiblelatestuserguideplaybooksfiltersipaddrhtml>A lot of IP address operation such as ipaddr</a></li><li><a href=#it-is-possible-to-add-more-vars-such-as-ansiblehost-to-inventory-host-declaration-as-stated-in-ansible-dochttpsdocsansiblecomansiblelatestuserguideintroinventoryhtml>It is possible to add more vars such as ansible_host to inventory host declaration as stated in ansible doc</a></li><li><a href=#it-is-important-to-put-groupsvars-under-inventory-folder-otherwise-ansibleplaybook-will-try-to-find-vars-under-the-same-folder-as-playbook-yaml-file>It is important to put groups_vars under inventory folder, otherwise, ansible-playbook will try to find vars under the same folder as playbook yaml file.</a></li><li><a href=#how-to-pass-list-or-dict-like-configurations-to-an-ini-style-inventory-file>How to pass list or dict like configurations to an INI style inventory file?</a></li><li><a href=#understand-replace-module>Understand replace module</a></li><li><a href=#ansible-provide-debuggerhttpsdocsansiblecomansiblelatestuserguideplaybooksdebuggerhtml-for-better-trouble-shooting>Ansible provide debugger for better trouble shooting.</a></li><li><a href=#understand-runonce-parameter-by-10-things-you-should-start-using-in-your-ansible-playbookhttpsmediumcomabhijeetkamble61910thingsyoushouldstartusinginyouransibleplaybook808daff76b65>Understand run_once parameter by 10 Things you should start using in your Ansible Playbook</a></li><li><a href=#latest-ansible-configure-filehttpsrawgithubusercontentcomansibleansibledevelexamplesansiblecfg>Latest ansible configure file</a></li><li><a href=#it-is-possibe-to-set-environment-variables-in-playbook-by-adding-environment-section-like-this>It is possibe to set environment variables in playbook by adding environment section like this:</a></li><li><a href=#about-jinja2-template-filtershttpjinjapocooorgdocs210templates-and-for-ansible-specifichttpsdocsansiblecomansiblelatestuserguideplaybooksfiltershtml>About jinja2 template filters, and for ansible specific</a></li><li><a href=#how-to-profile-ansible-playbook>How to profile ansible playbook?</a></li><li><a href=#pay-attention-to-meta-directory-in-ansible-role-because-roles-dependencies-will-be-defined-there>Pay attention to meta directory in ansible role, because role's dependencies will be defined there</a></li><li><a href=#how-to-fix-error-python2-bindings-for-rpm-are-needed-for-this-module>How to fix error: python2 bindings for rpm are needed for this module?</a></li><li><a href=#understand-blockhttpsdocsansiblecomansiblelatestuserguideplaybooksblockshtml-in-ansible-playbook>Understand block in ansible playbook</a></li><li><a href=#what-does-ansiblesshpipelininghttptoroidorgansiblesshpipelining-means>What does ansible_ssh_pipelining means?</a></li><li><a href=#variable-precedence-where-should-i-put-a-variablehttpsdocsansiblecomansible27userguideplaybooksvariableshtmlvariableprecedencewhereshouldiputavariable>Variable precedence: Where should I put a variable?</a></li><li><a href=#how-to-suppress-retry-file>How to suppress retry file?</a></li><li><a href=#ansible-meta-modulehttpsdocsansiblecomansible27modulesmetamodulehtml>Ansible meta module</a></li><li><a href=#ansible-configure-file-seach-paths>Ansible configure file seach paths:</a></li><li><a href=#install-ansiblerolesgraph-to-show-roles-dependencieshttpsgithubcomsebnansiblerolesgraph>Install ansible-roles-graph to show roles dependencies</a></li><li><a href=#about-hosts-pattern-matchhttpdocsansiblecomansiblelatestintropatternshtmlpatterns>About hosts pattern match</a></li><li><a href=#how-to-access-environment-varibles-on-remote-machine>How to access environment varibles on remote machine?</a></li><li><a href=#for-jinja2-template-how-to-evaluate-nested-variables>For jinja2 template, how to evaluate nested variables?</a></li><li><a href=#trouble-shooting-the-following-error>Trouble shooting the following error:</a></li><li><a href=#how-to-avoid-host-key-check-when-connect-to-remote-machine>How to avoid host key check when connect to remote machine?</a></li><li><a href=#how-to-pass-userpass-pair-when-calling-ansible>How to pass user/pass pair when calling ansible?</a></li><li><a href=#use-askpass-option-on-ansibleplaybook-to-ask-for-a-password-for-ssh-user>Use ask-pass option on ansible-playbook to ask for a password for ssh user</a></li><li><a href=#how-to-init-a-role-scaffolding>How to init a role scaffolding?</a></li><li><a href=#how-to-collect-remote-machine-facts>How to collect remote machine facts?</a></li><li><a href=#how-to-use-valut-to-protect-your-password>How to use Valut to protect your password?</a></li><li><a href=#how-to-disable-host-key-checkinghttpdocsansiblecomansibleintrogettingstartedhtmlremoteconnectioninformation>How to disable host key checking?</a></li><li><a href=#become-privilege-escalationhttpdocsansiblecomansiblebecomehtml>Become (Privilege Escalation)</a></li></ul><ul><li><a href=#how-to-install-ansible-on-centos-7-via-yumhttpwwwliquidwebcomkbhowtoinstallansibleoncentos7viayum>How to Install Ansible on CentOS 7 via yum</a></li><li><a href=#an-ansible-tutorialhttpsserversforhackerscomanansibletutorial>An Ansible Tutorial</a></li><li><a href=#primer-on-jinja-templatinghttpsgithubcommjhea0thinkfulmentortreemasterpythonjinja>Primer on Jinja Templating</a></li><li><a href=#playbook-conditionalhttpdocsansiblecomansibleplaybooksconditionalshtml>Playbook Conditional</a></li><li><a href=#jinja2-filtershttpdocsansiblecomansibleplaybooksfiltershtml>jinja2 filters</a></li><li><a href=#jinja-template-designer-documentationhttpjinjapocooorgdocsdevtemplatesbuiltinfilters>Jinja Template Designer Documentation</a></li><li><a href=#ansible-quick-referencehttpsgithubcomlorinansiblequickref>ansible quick reference</a></li></ul></nav></div></div><div class=post-content><h2 id=how-to-run-ansible-adhoc-commandhttpsdocsansiblecomansiblelatestuserguideintroadhochtml><a href=https://docs.ansible.com/ansible/latest/user_guide/intro_adhoc.html>How to run ansible adhoc command?</a></h2><blockquote><p><code>ansible &lt;targets> -m ping</code> to ping targets
<code>ansible &lt;targets> -a 'systemctl status'</code> to run a command on targets
<code>ansible &lt;targets> -m user -a "name=foo state=absent</code> to run a ansible module on targets</p></blockquote><h2 id=how-to-reboot-and-wait-for-linux-server-to-come-back>How to reboot and wait for linux server to come back?</h2><p>Sample code is as the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=c>## name: Upgrade Kernel | Reboot server</span><span class=w>
</span><span class=w>  </span>command<span class=p>:</span><span class=w> </span><span class=s1>&#39;sleep 5 &amp;&amp; /sbin/reboot&#39;</span><span class=w>
</span><span class=w>  </span>async<span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span><span class=w>  </span>poll<span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span><span class=w> 
</span><span class=w></span><span class=c>## name: Waiting for server to come back</span><span class=w>
</span><span class=w>  </span>local_action<span class=p>:</span><span class=w> </span>wait_for<span class=w> </span>host={{<span class=w> </span>ansible_ssh_host<span class=w> </span>}}<span class=w> </span>state=started<span class=w>
</span></code></pre></td></tr></table></div></div><p><em>Note</em>: it is important to sleep for a while before rebooting, otherwise, async seems not working, maybe because ssh connection is suddenly lost before async takes affect.
And for ansible >= 2.7, there is module called <a href=https://docs.ansible.com/ansible/latest/modules/reboot_module.html>reboot</a> for the same purpose.</p><h2 id=a-lot-of-ip-address-operation-such-as-ipaddrhttpsdocsansiblecomansiblelatestuserguideplaybooksfiltersipaddrhtml><a href=https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters_ipaddr.html>A lot of IP address operation such as <code>ipaddr</code></a></h2><h2 id=it-is-possible-to-add-more-vars-such-as-ansiblehost-to-inventory-host-declaration-as-stated-in-ansible-dochttpsdocsansiblecomansiblelatestuserguideintroinventoryhtml>It is possible to add more vars such as <code>ansible_host</code> to inventory host declaration as stated in <a href=https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html>ansible doc</a></h2><h2 id=it-is-important-to-put-groupsvars-under-inventory-folder-otherwise-ansibleplaybook-will-try-to-find-vars-under-the-same-folder-as-playbook-yaml-file>It is important to put <code>groups_vars</code> under <code>inventory</code> folder, otherwise, <code>ansible-playbook</code> will try to find vars under the same folder as playbook yaml file.</h2><h2 id=how-to-pass-list-or-dict-like-configurations-to-an-ini-style-inventory-file>How to pass list or dict like configurations to an INI style inventory file?</h2><p>Keep in mind that values in vars will be parsed/evaluated by <code>python</code>, so the following additional var should be valid (and it is possible to convert from and conver to json/yaml by jinja2 filters):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ini data-lang=ini><span class=k>[osds:vars]</span>
<span class=na>lvm_volumes</span><span class=o>=</span><span class=s>[{&#39;data&#39;: &#39;/dev/sdb&#39;}, {&#39;data&#39;: &#39;/dev/sdc&#39;}]</span>
</code></pre></td></tr></table></div></div><h2 id=understand-replace-module>Understand <code>replace</code> module</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>  </span>replace<span class=p>:</span><span class=w>
</span><span class=w>    </span>path<span class=p>:</span><span class=w> </span>/etc/default/grub<span class=w>
</span><span class=w>    </span>regexp<span class=p>:</span><span class=w> </span><span class=s1>&#39;^(GRUB_DEFAULT)=.*$&#39;</span><span class=w>
</span><span class=w>    </span>replace<span class=p>:</span><span class=w> </span><span class=s1>&#39;\1=0&#39;</span><span class=w>
</span><span class=w>    </span>backup<span class=p>:</span><span class=w> </span>yes<span class=w>
</span></code></pre></td></tr></table></div></div><p>In the above action, the regexp will capture <code>GRUB_DEFAULT</code> as the first group, which will be used in <code>'\1=0</code>, change this line to <code>GRUB_DEFAULT=0</code></p><h2 id=ansible-provide-debuggerhttpsdocsansiblecomansiblelatestuserguideplaybooksdebuggerhtml-for-better-trouble-shooting>Ansible provide <a href=https://docs.ansible.com/ansible/latest/user_guide/playbooks_debugger.html>debugger</a> for better trouble shooting.</h2><p>When trapped in debugger, you can use <code>p</code> command to print current task state, available state includes: <code>result._result, task, task.args, task_vars</code>, and you can also change those states with format like <code>task.args[key] = value</code>. And then you can <code>redo(r)</code> or <code>continue(c)</code>, or just <code>quit(q)</code>. When <code>p</code> vars, it is possible to print like this <code>p task_vars.keys()</code> since <code>task_vars</code> here is a python dict object, <code>p task_vars['hostvars']['osd0']['lvm_volumes']</code></p><h2 id=understand-runonce-parameter-by-10-things-you-should-start-using-in-your-ansible-playbookhttpsmediumcomabhijeetkamble61910thingsyoushouldstartusinginyouransibleplaybook808daff76b65>Understand <code>run_once</code> parameter by <a href=https://medium.com/@abhijeet.kamble619/10-things-you-should-start-using-in-your-ansible-playbook-808daff76b65>10 Things you should start using in your Ansible Playbook</a></h2><blockquote><p>By default, Ansible will select the first host from the group to execute. This can also be used with delegate_to to run the task on specific server.</p></blockquote><h2 id=latest-ansible-configure-filehttpsrawgithubusercontentcomansibleansibledevelexamplesansiblecfg><a href=https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg>Latest ansible configure file</a></h2><h2 id=it-is-possibe-to-set-environment-variables-in-playbook-by-adding-environment-section-like-this>It is possibe to set environment variables in playbook by adding <code>environment</code> section like this:</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=c>## hosts: all</span><span class=w>
</span><span class=w>  </span>remote_user<span class=p>:</span><span class=w> </span>root<span class=w>
</span><span class=w>  </span><span class=c># here we make a variable named &#34;proxy_env&#34; that is a dictionary</span><span class=w>
</span><span class=w>  </span>vars<span class=p>:</span><span class=w>
</span><span class=w>    </span>proxy_env<span class=p>:</span><span class=w>
</span><span class=w>      </span>http_proxy<span class=p>:</span><span class=w> </span>http<span class=p>:</span>//proxy.example.com<span class=p>:</span><span class=m>8080</span><span class=w>
</span><span class=w>  </span>tasks<span class=p>:</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>apt<span class=p>:</span><span class=w> </span>name=cobbler<span class=w> </span>state=installed<span class=w>
</span><span class=w>      </span>environment<span class=p>:</span><span class=w> </span><span class=s2>&#34;{{proxy_env}}&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><h2 id=about-jinja2-template-filtershttpjinjapocooorgdocs210templates-and-for-ansible-specifichttpsdocsansiblecomansiblelatestuserguideplaybooksfiltershtml>About <a href=http://jinja.pocoo.org/docs/2.10/templates/>jinja2 template filters</a>, and for <a href=https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html>ansible specific</a></h2><h2 id=how-to-profile-ansible-playbook>How to profile ansible playbook?</h2><p>As of Ansible 2.0, just add <code>callback_whitelist = profile_tasks</code> to your ansible.cfg file [defaults] section, which is one type of <code>callback_plugins</code> for ansible.</p><h2 id=pay-attention-to-meta-directory-in-ansible-role-because-roles-dependencies-will-be-defined-there>Pay attention to &ldquo;meta&rdquo; directory in ansible role, because role's dependencies will be defined there</h2><h2 id=how-to-fix-error-python2-bindings-for-rpm-are-needed-for-this-module>How to fix error: <em>python2 bindings for rpm are needed for this module</em>?</h2><p>Possible root cause is that default python is configured as python3 on the remote machine. Just add <code>ansible_python_interpreter=/usr/bin/python2.7</code> var.</p><h2 id=understand-blockhttpsdocsansiblecomansiblelatestuserguideplaybooksblockshtml-in-ansible-playbook>Understand <a href=https://docs.ansible.com/ansible/latest/user_guide/playbooks_blocks.html><code>block</code></a> in ansible playbook</h2><blockquote><p>Blocks allow for logical grouping of tasks and in play error handling.Most of what you can apply to a single task (with the exception of loops) can be applied at the block level, which also makes it much easier to set data or directives common to the tasks. This does not mean the directive affects the block itself, but is inherited by the tasks enclosed by a block. i.e. a when will be applied to the tasks, not the block itself.</p></blockquote><h2 id=what-does-ansiblesshpipelininghttptoroidorgansiblesshpipelining-means>What does <a href=http://toroid.org/ansible-ssh-pipelining><code>ansible_ssh_pipelining</code></a> means?</h2><blockquote><p>Ansible will normally create a temporary directory under ~/.ansible (via ssh), then for each task, copy the module source to the directory (using sftp or scp) and execute the module (ssh again).
With pipelining enabled, Ansible will connect only once per task using ssh to execute python, and write the module source to its stdin.</p></blockquote><h2 id=variable-precedence-where-should-i-put-a-variablehttpsdocsansiblecomansible27userguideplaybooksvariableshtmlvariableprecedencewhereshouldiputavariable><a href=https://docs.ansible.com/ansible/2.7/user_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable>Variable precedence: Where should I put a variable?</a></h2><p>Here is the order of precedence from least to greatest (the last listed variables winning prioritization):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ini data-lang=ini><span class=c1>## command line values (eg “-u user”)</span>
<span class=c1>## role defaults [1]</span>
<span class=c1>## inventory file or script group vars [2]</span>
<span class=c1>## inventory group_vars/all [3]</span>
<span class=c1>## playbook group_vars/all [3]</span>
<span class=c1>## inventory group_vars/* [3]</span>
<span class=c1>## playbook group_vars/* [3]</span>
<span class=c1>## inventory file or script host vars [2]</span>
<span class=c1>## inventory host_vars/* [3]</span>
<span class=c1>## playbook host_vars/* [3]</span>
<span class=c1>## host facts / cached set_facts [4]</span>
<span class=c1>## play vars</span>
<span class=c1>## play vars_prompt</span>
<span class=c1>## play vars_files</span>
<span class=c1>## role vars (defined in role/vars/main.yml)</span>
<span class=c1>## block vars (only for tasks in block)</span>
<span class=c1>## task vars (only for the task)</span>
<span class=c1>## include_vars</span>
<span class=c1>## set_facts / registered vars</span>
<span class=c1>## role (and include_role) params</span>
<span class=c1>## include params</span>
<span class=c1>## extra vars (always win precedence)</span>
</code></pre></td></tr></table></div></div><h2 id=how-to-suppress-retry-file>How to suppress retry file?</h2><blockquote><p>add the following configuration to ansible.cfg <em>defaults</em> section:
retry_files_enabled = False</p></blockquote><h2 id=ansible-meta-modulehttpsdocsansiblecomansible27modulesmetamodulehtml><a href=https://docs.ansible.com/ansible/2.7/modules/meta_module.html>Ansible meta module</a></h2><blockquote><p>Meta tasks are a special kind of task which can influence Ansible internal execution or state.
flush_handlers makes Ansible run any handler tasks which have thus far been notified.</p></blockquote><h2 id=ansible-configure-file-seach-paths>Ansible configure file seach paths:</h2><blockquote><p>Changes can be made and used in a configuration file which will be processed in the following order:
ANSIBLE_CONFIG (an environment variable)
ansible.cfg (in the current directory)
.ansible.cfg (in the home directory)
/etc/ansible/ansible.cfg</p></blockquote><h2 id=install-ansiblerolesgraph-to-show-roles-dependencieshttpsgithubcomsebnansiblerolesgraph><a href=https://github.com/sebn/ansible-roles-graph>Install ansible-roles-graph to show roles dependencies</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># Install graphvis from http://graphviz.org/Download_macos.php</span>
pip install ansible-roles-graph
</code></pre></td></tr></table></div></div><p>NOT WORKING.
Try another one called <a href=https://github.com/nickjj/ansigenome>ansigenome</a></p><h2 id=about-hosts-pattern-matchhttpdocsansiblecomansiblelatestintropatternshtmlpatterns><a href=http://docs.ansible.com/ansible/latest/intro_patterns.html#patterns>About hosts pattern match</a></h2><p>host match is separted by colon.</p><p>could be written as: <em>hosts: kube-master[0]</em> to only play on the first kube-master node
could be written as <em>hosts: etcd:k8s-cluster:vault:calico-rr</em> to play on multiple types of nodes</p><h2 id=how-to-access-environment-varibles-on-remote-machine>How to access environment varibles on remote machine?</h2><p>Could be accessed by: <code>{{ ansible_var.&lt;Var name> }}</code> such as <code>{{ ansible_var.USER }}</code></p><h2 id=for-jinja2-template-how-to-evaluate-nested-variables>For jinja2 template, how to evaluate nested variables?</h2><p>Wrong template file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=p>{</span><span class=o>%</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>groups</span><span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>peer</span><span class=s2>&#34;</span><span class=p>]</span><span class=o>|</span><span class=n>length</span><span class=p>)</span>  <span class=o>%</span><span class=p>}</span>
       <span class=o>-</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>peer{{i}}.rong.easy-sight.com:{{ groups[</span><span class=s2>&#39;</span><span class=s2>peer</span><span class=s2>&#39;</span><span class=s2>][{{i}}] }}</span><span class=s2>&#34;</span>
<span class=p>{</span><span class=o>%</span><span class=n>endfor</span><span class=o>%</span><span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong>Should not use double brace in nested style</strong>.
Correct one:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=p>{</span><span class=o>%</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>groups</span><span class=p>[</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>peer</span><span class=s2>&#34;</span><span class=p>]</span><span class=o>|</span><span class=n>length</span><span class=p>)</span>  <span class=o>%</span><span class=p>}</span>
       <span class=o>-</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>peer{{i}}.rong.easy-sight.com:{{ groups[</span><span class=s2>&#39;</span><span class=s2>peer</span><span class=s2>&#39;</span><span class=s2>][i] }}</span><span class=s2>&#34;</span>
<span class=p>{</span><span class=o>%</span><span class=n>endfor</span><span class=o>%</span><span class=p>}</span>
</code></pre></td></tr></table></div></div><h2 id=trouble-shooting-the-following-error>Trouble shooting the following error:</h2><blockquote><p>fatal: [dev15]: FAILED! => {&ldquo;failed&rdquo;: true, &ldquo;msg&rdquo;: &ldquo;Timeout (12s) waiting for privilege escalation prompt: &ldquo;}</p></blockquote><p>Followed <a href=https://github.com/ansible/ansible/issues/14426>this thread</a>, which suggested the following ways:</p><pre><code>+ Add `transport=paramiko` to **~/.ansible.cfg** file. ==&gt; This fixed the issue.
  *Paramiko is a Python (2.6+, 3.3+) implementation of the SSHv2 protocol*
+ Add `sudo: yes` to  playbook, in the same place configuring **remote_user**.
</code></pre><h2 id=how-to-avoid-host-key-check-when-connect-to-remote-machine>How to avoid host key check when connect to remote machine?</h2><blockquote><p>Add the line <code>host_key_checking = False</code> to <em>~/.ansible.cfg</em> file.
or, just <code>export ANSIBLE_HOST_KEY_CHECKING=False</code></p></blockquote><h2 id=how-to-pass-userpass-pair-when-calling-ansible>How to pass user/pass pair when calling ansible?</h2><p>You can add following section to your inventory file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ini data-lang=ini><span class=k>[all:vars]</span>
<span class=na>ansible_connection</span><span class=o>=</span><span class=s>ssh </span>
<span class=na>ansible_ssh_user</span><span class=o>=</span><span class=s>vagrant </span>
<span class=na>ansible_ssh_pass</span><span class=o>=</span><span class=s>vagrant</span>
</code></pre></td></tr></table></div></div><h2 id=use-askpass-option-on-ansibleplaybook-to-ask-for-a-password-for-ssh-user>Use <em>&ndash;ask-pass</em> option on ansible-playbook to ask for a password for ssh user</h2><p>Like this: <code>ansible-playbook -i allhosts test.yml --ask-pass</code></p><p>Alternatively, you can use a password file to avoid inputting password:</p><pre><code>+ Add the following line to _/etc/ansible/ansible.cfg_ or ~/.ansible.cfg: `vault_password_file = ~/.vault_pass`
+ `echo &quot;password&quot; &gt; ~/.vault_pass`
+ `chmod 600 ~/.vault_pass`
</code></pre><h2 id=how-to-init-a-role-scaffolding>How to init a role <strong>scaffolding</strong>?</h2><p>Use <code>ansible-galaxy init</code> command like this: <code>ansible-galaxy init -p roles nginx</code></p><h2 id=how-to-collect-remote-machine-facts>How to collect remote machine <em>facts</em>?</h2><p>Use <strong>setup</strong> module like this: <code>ansiable -m setup www</code></p><h2 id=how-to-use-valut-to-protect-your-password>How to use Valut to protect your password?</h2><p>First, create a var file with vault, like this:<code>ansible-vault create vars/main.yml</code>, edit with:<code>ansible-vault edit vars/main.yml</code>, and at deployment time: <code>ansible-playbook --ask-vault-pass site.yml</code></p><h2 id=how-to-disable-host-key-checkinghttpdocsansiblecomansibleintrogettingstartedhtmlremoteconnectioninformation><a href=http://docs.ansible.com/ansible/intro_getting_started.html#remote-connection-information>How to disable host key checking?</a></h2><p>By editing <em>/etc/ansible/ansible.cfg</em> or <em>~/.ansible.cfg</em>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ini data-lang=ini><span class=k>[defaults]</span>
<span class=na>host_key_checking</span> <span class=o>=</span> <span class=s>False</span>
</code></pre></td></tr></table></div></div><p>Alternatively this can be set by an environment variable:<code>export ANSIBLE_HOST_KEY_CHECKING=False</code></p><h2 id=become-privilege-escalationhttpdocsansiblecomansiblebecomehtml><a href=http://docs.ansible.com/ansible/become.html>Become (Privilege Escalation)</a></h2><blockquote><p>Directives: <em>become</em>, <em>become_user</em>, <em>become_method</em>
Connection <strong>variables</strong>: <em>ansible_become</em>, <em>ansible_become_method</em>, <em>ansible_become_user</em>, <em>ansible_become_pass</em>
Command line option: <em>&ndash;ask-become-pass, -K</em>, <em>&ndash;become, -b</em>, <em>&ndash;become-user=BECOME_USER</em>. Like this:<code>ansible all -m ping -K</code></p></blockquote><h1 id=reference>Reference</h1><h2 id=how-to-install-ansible-on-centos-7-via-yumhttpwwwliquidwebcomkbhowtoinstallansibleoncentos7viayum><a href=http://www.liquidweb.com/kb/how-to-install-ansible-on-centos-7-via-yum/>How to Install Ansible on CentOS 7 via yum</a></h2><h2 id=an-ansible-tutorialhttpsserversforhackerscomanansibletutorial><a href=https://serversforhackers.com/an-ansible-tutorial>An Ansible Tutorial</a></h2><h2 id=primer-on-jinja-templatinghttpsgithubcommjhea0thinkfulmentortreemasterpythonjinja><a href=https://github.com/mjhea0/thinkful-mentor/tree/master/python/jinja>Primer on Jinja Templating</a></h2><h2 id=playbook-conditionalhttpdocsansiblecomansibleplaybooksconditionalshtml><a href=http://docs.ansible.com/ansible/playbooks_conditionals.html>Playbook Conditional</a></h2><ul><li><em>A number of Jinja2 “filters” can also be used in when statements, some of which are unique and provided by Ansible.</em></li><li><em>Combining when with with_items (see Loops), be aware that the when statement is processed separately for each item</em></li><li><em>the registered variable’s string contents are accessible with the ‘stdout’ value.</em></li></ul><h2 id=jinja2-filtershttpdocsansiblecomansibleplaybooksfiltershtml><a href=http://docs.ansible.com/ansible/playbooks_filters.html>jinja2 filters</a></h2><h2 id=jinja-template-designer-documentationhttpjinjapocooorgdocsdevtemplatesbuiltinfilters><a href=http://jinja.pocoo.org/docs/dev/templates/#builtin-filters>Jinja Template Designer Documentation</a></h2><h2 id=ansible-quick-referencehttpsgithubcomlorinansiblequickref><a href=https://github.com/lorin/ansible-quickref>ansible quick reference</a></h2></div><footer class=post-footer><nav class=post-nav><a class=prev href=/post/tips/gradle/><i class="iconfont icon-left"></i><span class="prev-text nav-default">gradle</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=/post/tips/awk/><span class="next-text nav-default">awk</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:leowa@outlook.com class="iconfont icon-email" title=email></a><a href=https://github.com/leowa class="iconfont icon-github" title=github></a><a href=http://localhost:1313/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=copyright-year>&copy;
2019
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>Andy Zhang</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/dist/even.26188efa.min.js></script></body></html>