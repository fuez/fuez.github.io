<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>makefile - Andy's Blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="Andy Zhang"><meta name=description content="Two flavours of variables  The first flavor of variable is a recursively expanded variable. Variables of this sort are defined by lines using ‘=’ (see Setting Variables) or by the define directive. If it contains references to other variables, these references are expanded whenever this variable is substituted. To avoid all the problems and inconveniences of recursively expanded variables, there is another flavor: simply expanded variables. Simply expanded variables are defined by lines using ‘:=’ or ‘::=’."><meta name=keywords content="linux,SRE,software"><meta name=generator content="Hugo 0.60.1 with theme even"><link rel=canonical href=http://localhost:1313/post/tips/makefile/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/dist/even.c2a46f00.min.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="makefile"><meta property="og:description" content="Two flavours of variables  The first flavor of variable is a recursively expanded variable. Variables of this sort are defined by lines using ‘=’ (see Setting Variables) or by the define directive. If it contains references to other variables, these references are expanded whenever this variable is substituted. To avoid all the problems and inconveniences of recursively expanded variables, there is another flavor: simply expanded variables. Simply expanded variables are defined by lines using ‘:=’ or ‘::=’."><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/post/tips/makefile/"><meta property="article:published_time" content="2018-09-06T13:50:45+08:00"><meta property="article:modified_time" content="2019-12-06T17:10:09+08:00"><meta itemprop=name content="makefile"><meta itemprop=description content="Two flavours of variables  The first flavor of variable is a recursively expanded variable. Variables of this sort are defined by lines using ‘=’ (see Setting Variables) or by the define directive. If it contains references to other variables, these references are expanded whenever this variable is substituted. To avoid all the problems and inconveniences of recursively expanded variables, there is another flavor: simply expanded variables. Simply expanded variables are defined by lines using ‘:=’ or ‘::=’."><meta itemprop=datePublished content="2018-09-06T13:50:45+08:00"><meta itemprop=dateModified content="2019-12-06T17:10:09+08:00"><meta itemprop=wordCount content="604"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="makefile"><meta name=twitter:description content="Two flavours of variables  The first flavor of variable is a recursively expanded variable. Variables of this sort are defined by lines using ‘=’ (see Setting Variables) or by the define directive. If it contains references to other variables, these references are expanded whenever this variable is substituted. To avoid all the problems and inconveniences of recursively expanded variables, there is another flavor: simply expanded variables. Simply expanded variables are defined by lines using ‘:=’ or ‘::=’."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Andy's Blog</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>Andy's Blog</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>makefile</h1><div class=post-meta><span class=post-time>2018-09-06</span><div class=post-category><a href=/categories/tip/>tip</a></div><span class=more-meta>604 words</span>
<span class=more-meta>3 mins read</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#two-flavours-of-variableshttpswwwgnuorgsoftwaremakemanualhtmlnodeflavorshtml>Two flavours of variables</a></li><li><a href=#setting-variableshttpswwwgnuorgsoftwaremakemanualhtmlnodesettinghtml>Setting Variables</a></li><li><a href=#you-can-make-template-make-target-together-with--like-this>You can make template make target together with % like this:</a></li><li><a href=#should-learn-something-about-makefile-file-name-functionshttpswwwgnuorgsoftwaremakemanualhtmlnodefilenamefunctionshtml>Should learn something about Makefile file name functions</a></li><li><a href=#what-does--meanshttpwwwgnuorgsoftwaremakemanualhtmlnodesettinghtml>What does ?= means?</a></li><li><a href=#getting-environment-variables-into-gnu-makehttpswwwcmcrossroadscomarticlebasicsgettingenvironmentvariablesgnumake>Getting environment variables into GNU Make</a></li></ul></nav></div></div><div class=post-content><h2 id=two-flavours-of-variableshttpswwwgnuorgsoftwaremakemanualhtmlnodeflavorshtml><a href=https://www.gnu.org/software/make/manual/html_node/Flavors.html>Two flavours of variables</a></h2><blockquote><p>The first flavor of variable is a recursively expanded variable. Variables of this sort are defined by lines using ‘=’ (see Setting Variables) or by the define directive.
If it contains references to other variables, these references are expanded whenever this variable is substituted.
To avoid all the problems and inconveniences of recursively expanded variables, there is another flavor: simply expanded variables.
Simply expanded variables are defined by lines using ‘:=’ or ‘::=’. Both forms are equivalent in GNU make; however only the ‘::=’ form is described by the POSIX standard
The value of a simply expanded variable is scanned once and for all, expanding any references to other variables and functions, when the variable is defined. The actual value of the simply expanded variable is the result of expanding the text that you write. It does not contain any references to other variables; it contains their values as of the time this variable was defined.
When a simply expanded variable is referenced, its value is substituted verbatim.</p></blockquote><h2 id=setting-variableshttpswwwgnuorgsoftwaremakemanualhtmlnodesettinghtml><a href=https://www.gnu.org/software/make/manual/html_node/Setting.html>Setting Variables</a></h2><blockquote><p>If you’d like a variable to be set to a value only if it’s not already set, then you can use the shorthand operator ‘?=’ instead of ‘=’
The shell assignment operator ‘!=’ can be used to execute a shell script and set a variable to its output. This operator first evaluates the right-hand side, then passes that result to the shell for execution. If the result of the execution ends in a newline, that one newline is removed; all other newlines are replaced by spaces. The resulting string is then placed into the named recursively-expanded variable. Like this: <code>hash != printf '\043'</code>
Alternatively, you can set a simply expanded variable to the result of running a program using the shell function call, which I think is better. Like this: <code>hash := $(shell printf '\043')</code></p></blockquote><h2 id=you-can-make-template-make-target-together-with--like-this>You can make template make target together with <code>%</code> like this:</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>.PHONY: push-%
push-%:
	<span class=k>$(</span>MAKE<span class=k>)</span> <span class=nv>GOARCH</span><span class=o>=</span><span class=nv>$*</span> docker
	docker push <span class=k>$(</span>DOCKER_IMAGE_NAME<span class=k>)</span>:<span class=k>$(</span>DOCKER_IMAGE_TAG<span class=k>)</span>-<span class=nv>$*</span>

.PHONY: push
push: manifest-tool <span class=k>$(</span>addprefix push-,<span class=k>$(</span>ALL_ARCH<span class=k>)</span><span class=k>)</span> manifest-push
</code></pre></td></tr></table></div></div><h2 id=should-learn-something-about-makefile-file-name-functionshttpswwwgnuorgsoftwaremakemanualhtmlnodefilenamefunctionshtml>Should learn something about Makefile <a href=https://www.gnu.org/software/make/manual/html_node/File-Name-Functions.html>file name functions</a></h2><blockquote><p>Each of the following functions performs a specific transformation on a file name. The argument of the function is regarded as a series of file names, separated by whitespace.
- <code>$(dir names…)</code> to Extracts the directory-part of each file name in names.
- <code>$(notdir names…)</code> to Extracts all but the directory-part of each file name in names.
- <code>$(suffix names…)</code> to Extracts the suffix of each file name in names.
- <code>$(basename names…)</code> to Extracts all but the suffix of each file name in names.
- <code>$(addsuffix suffix,names…)</code> - The value of suffix is appended to the end of each individual name and the resulting larger names are concatenated with single spaces between them
- <code>$(addprefix prefix,names…)</code>
- <code>$(join list1,list2)</code>
- <code>$(wildcard pattern)</code> - The result of wildcard is a space-separated list of the names of existing files that match the pattern.
- <code>$(realpath names…)</code>
- <code>$(abspath names…)</code></p></blockquote><h2 id=what-does--meanshttpwwwgnuorgsoftwaremakemanualhtmlnodesettinghtml><a href=http://www.gnu.org/software/make/manual/html_node/Setting.html>What does <strong>?=</strong> means?</a></h2><blockquote><p>Variables defined with ‘=’ are recursively expanded variables. Variables defined with ‘:=’ or ‘::=’ are simply expanded variables, only the ‘::=’ form is described by the POSIX standard.</p></blockquote><blockquote><p>If you’d like a variable to be set to a value only if it’s not already set, then you can use the shorthand operator ‘?=’ instead of ‘=’.</p></blockquote><blockquote><p>The shell assignment operator ‘!=’ can be used to execute a shell script and set a variable to its output.</p></blockquote><h2 id=getting-environment-variables-into-gnu-makehttpswwwcmcrossroadscomarticlebasicsgettingenvironmentvariablesgnumake><a href=https://www.cmcrossroads.com/article/basics-getting-environment-variables-gnu-make>Getting environment variables into GNU Make</a></h2><p>A simple test example:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>echo</span> <span class=s2>&#34;\$(warning \$(FOO) \$(origin FOO))&#34;</span> &gt; /tmp/Makefile
<span class=nv>FOO</span><span class=o>=</span>hello make -f /tmp/Makfile -e <span class=nv>FOO</span><span class=o>=</span>world
</code></pre></td></tr></table></div></div></div><footer class=post-footer><nav class=post-nav><a class=prev href=/post/tips/jenkins/><i class="iconfont icon-left"></i><span class="prev-text nav-default">jenkins</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=/post/tips/ubuntu/><span class="next-text nav-default">ubuntu</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:leowa@outlook.com class="iconfont icon-email" title=email></a><a href=https://github.com/leowa class="iconfont icon-github" title=github></a><a href=http://localhost:1313/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=copyright-year>&copy;
2019 -
2020
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>Andy Zhang</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/dist/even.26188efa.min.js></script></body></html>